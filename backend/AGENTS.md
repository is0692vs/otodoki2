# `backend/` ディレクトリの AGENT ルール

このディレクトリには、FastAPI を用いた Web アプリケーションのバックエンドコードが含まれています。

## 構造と役割

- `app/`: FastAPI アプリケーションの主要なソースコード。ルーティング、ビジネスロジック、モデル、サービスなどが含まれます。
- `tests/`: バックエンドアプリケーションのユニットテストおよび統合テストが含まれます。
- `Dockerfile`: バックエンドアプリケーションを Docker コンテナとしてビルドするための定義ファイル。
- `requirements.txt`: バックエンドアプリケーションの Python 依存関係が記述されています。

## 主要なコンポーネント

- `app/main.py`: FastAPI アプリケーションのエントリポイント。API ルートの定義とアプリケーションの初期化を行います。
- `app/core/config.py`: アプリケーション全体の設定を管理します。環境変数からの値の読み込みとデフォルト値の提供を行います。
- `app/services/worker.py`: バックグラウンドで動作し、iTunes API から楽曲データを取得し、キューを補充するワーカーロジックが含まれます。

## テストと検証のポイント

- バックエンドの振る舞い確認は `make up` もしくは `docker compose up -d --build` で環境を立ち上げ、`docker compose logs -f api` でワーカーや検索戦略のログを追う。
- キュー補充が正しく動作しているかを確認するため、Gemini 戦略が失敗した場合でも `random_keyword` などの代替戦略にフォールバックしているかログでチェックする。
- API レスポンスは必ず `curl http://localhost:8000/api/v1/tracks/suggestions?limit=5` などで実際に取得し、`meta.queue_size_after` などのメタ情報も確認する。
- 検証完了後は `docker compose down` でコンテナを停止し、クリーンアップする。

## AI エージェントへの指示

- バックエンドの機能追加や変更を行う際は、`app/` ディレクトリ内の適切なモジュールを特定し、変更を加えてください。
- テストを必ず記述し、既存のテストが壊れていないことを確認してください。`tests/` ディレクトリに新しいテストファイルを追加するか、既存のテストファイルを更新してください。
- 環境変数に関する設定を変更する場合は、`app/core/config.py` を更新し、必要に応じて `README.md` の環境変数セクションも更新してください。
- 依存関係を追加する場合は、`requirements.txt` を更新してください。
