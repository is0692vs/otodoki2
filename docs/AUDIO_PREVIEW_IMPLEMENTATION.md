# 音楽プレビュー自動再生機能

Issue #13 で実装した「カード表示時のプレビュー自動再生」機能の実装詳細です。

## 実装概要

このプルリクエストでは、スワイプデッキの最前面カードが切り替わった際に、その曲のプレビュー URL を自動再生し、次のカードに移る際に再生中の音源を停止する機能を実装しました。

## 主要機能

### 1. 音楽再生管理 (`useAudioPlayer`)

- **ファイル**: `/src/hooks/useAudioPlayer.ts`
- **責務**: 単一の Audio インスタンスによる集中管理
- **機能**:
  - 自動再生（初回はミュート状態）
  - ミュート/アンミュート切替
  - 再生/一時停止制御
  - エラーハンドリング
  - プリロード機能（次の 1 曲）

### 2. 可視性監視 (`useVisibility`)

- **ファイル**: `/src/hooks/useVisibility.ts`
- **責務**: カードとページの可視性監視
- **機能**:
  - IntersectionObserver によるカード可視性監視
  - Page Visibility API によるタブアクティブ状態監視
  - 非可視時の自動一時停止

### 3. キーボードショートカット (`useKeyboardShortcuts`)

- **ファイル**: `/src/hooks/useKeyboardShortcuts.ts`
- **責務**: キーボード操作による UX 向上
- **機能**:
  - スペースキー: 再生/一時停止切替
  - 左矢印キー: 左スワイプ
  - 右矢印キー: 右スワイプ

### 4. SwipeStack 拡張

- **ファイル**: `/src/components/SwipeStack.tsx`
- **追加機能**:
  - 音楽再生制御の統合
  - 最前面カード変更時の自動再生トリガー
  - 可視性監視による一時停止
  - 音楽制御 UI の追加

### 5. SwipeCard 拡張

- **ファイル**: `/src/components/SwipeCard.tsx`
- **追加機能**:
  - 再生状態のビジュアル表示
  - プレビュー利用可否のインジケーター

### 6. TrackCard 拡張

- **ファイル**: `/src/components/TrackCard.tsx`
- **追加機能**:
  - オプションの音楽制御 UI
  - ホバー時の制御ボタン表示
  - エラー状態の表示

## 主要な動作フロー

### 初期表示

1. SwipeStack がマウントされると、useAudioPlayer が初期化
2. 初回は`isMuted=true`で Audio インスタンスを作成
3. 最前面カードの`preview_url`で自動再生を試行

### カード切替

1. スワイプまたはボタンで前のカードが退場
2. `audioPlayer.stop()`で現在の再生を停止
3. `currentIndex`が更新され、新しい最前面カードに切替
4. useEffect が新しいカードを検知し、`audioPlayer.playTrack()`を実行
5. 次のカードがあれば`preloadTrack()`でプリロード

### 可視性制御

1. IntersectionObserver がカードの可視性を監視
2. Page Visibility API がタブのアクティブ状態を監視
3. 非可視またはタブ非アクティブ時に自動一時停止
4. 復帰時に状態に応じて自動再開

## エラーハンドリング

### 自動再生失敗

- ブラウザの自動再生ポリシーで拒否された場合
- ミュート状態での再生を再試行
- 失敗時は UI に「再生ボタンをクリックしてください」表示

### プレビュー URL 不正

- HTTP エラー、CORS、404 などの場合
- UI に「プレビュー利用不可」表示
- アプリはクラッシュせず次のカードに移行可能

### ネットワーク障害

- 読み込み失敗時にフォールバック表示
- プリロード失敗はサイレントに処理

## アクセシビリティ対応

### ARIA ラベル

- 再生ボタン: `aria-label=\"再生\"` / `aria-label=\"一時停止\"`
- ミュートボタン: `aria-label=\"ミュート\"` / `aria-label=\"ミュート解除\"`
- スワイプボタン: `aria-label=\"好き\"` / `aria-label=\"嫌い\"`

### キーボード操作

- スペースキー: 再生/一時停止
- 左右矢印: スワイプ操作
- 入力フィールドフォーカス時は無効化

### 音声制御

- デフォルトはミュート状態で開始
- ユーザーの明示的操作後にアンミュート可能
- 状態はカード間で引き継がれる

## パフォーマンス最適化

### リソース管理

- Audio インスタンスは 1 つのみ保持
- ページアンマウント時の確実なリソース解放
- プリロードは最大 1 曲に制限

### アニメーション分離

- スワイプアニメーションと音楽切替を分離
- レイアウトスレッドをブロックしない設計
- モーションライブラリとの競合回避

## 設定値

### 定数（useAudioPlayer）

- `AUTOPLAY_DEFAULT_MUTED`: true
- `PRELOAD_NEXT_COUNT`: 1
- `defaultVolume`: 0.7

### IntersectionObserver

- `threshold`: 0.5 (50%可視で有効)
- `rootMargin`: '0px'

## テスト方法

### 正常系テスト

1. `/swipe`ページにアクセス
2. 最前面カードで自動再生開始を確認
3. スワイプして次のカードで前曲停止・新曲再生を確認
4. ミュート切替が次のカードに引き継がれることを確認

### エラー系テスト

1. プレビュー URL がないカードでのフォールバック表示確認
2. ネットワーク切断時の動作確認
3. タブ切替時の一時停止・復帰確認

### UX テスト

1. 連続スワイプでの音切替ノイズがないことを確認
2. スペースキーでの再生制御確認
3. 画面外移動時の一時停止確認

## ブラウザ対応

### 自動再生ポリシー

- Chrome/Edge: 初回ミュート再生で対応
- Safari: ユーザージェスチャー後に有効化
- Firefox: 設定依存、フォールバック対応

### Web Audio API

- 全モダンブラウザ対応
- IE11 以下は対象外

## 今後の拡張可能性

### 機能拡張

- 再生進捗表示
- 音量スライダー
- フェードイン/フェードアウト
- イコライザー機能

### UX 改善

- スワイプ速度による音切替タイミング調整
- ジェスチャー感度の細かい調整
- バックグラウンド再生対応

---

この実装により、Issue #13 の仕様要件「一番手前のカードのプレビューを自動再生し、次カードで停止」を満たす MVP 体験を安定して提供できます。
