name: "üìã Gemini Bulk Triage"

on:
    workflow_call:
        inputs:
            issues_to_triage:
                type: "string"
                description: "JSON array of issues to triage"
                required: true
            additional_context:
                type: "string"
                description: "Any additional context from the request"
                required: false
            language:
                type: "string"
                description: "Response language (default: 'ja' ‚Äî JP)."
                default: "ja"
            gcp_location:
                type: "string"
                description: "GCP location override"
                required: false
                default: ""
            gcp_project_id:
                type: "string"
                description: "GCP project id override"
                required: false
                default: ""
            gcp_service_account:
                type: "string"
                description: "GCP service account override"
                required: false
                default: ""
            gcp_workload_identity_provider:
                type: "string"
                description: "GCP WIF provider override"
                required: false
                default: ""
            gemini_cli_version:
                type: "string"
                description: "Gemini CLI version override"
                required: false
                default: ""
            gemini_debug:
                type: "string"
                description: "Gemini debug override"
                required: false
                default: "false"
            gemini_model:
                type: "string"
                description: "Gemini model override"
                required: false
                default: ""
            use_gemini_code_assist:
                type: "string"
                description: "Whether to use Gemini Code Assist"
                required: false
                default: "false"
            use_vertex_ai:
                type: "string"
                description: "Whether to use Vertex AI"
                required: false
                default: "false"
        secrets:
            GEMINI_API_KEY:
                required: false
            GOOGLE_API_KEY:
                required: false

defaults:
    run:
        shell: "bash"

jobs:
    triage_bulk:
        runs-on: "ubuntu-latest"
        permissions:
            contents: "read"
            id-token: "write"
            issues: "read"
            pull-requests: "read"
        outputs:
            available_labels: "${{ steps.get_labels.outputs.available_labels }}"
            triaged_issues: "${{ steps.collect_outputs.outputs.triaged_issues }}"
        steps:
            - name: "Get repository labels"
              id: "get_labels"
              uses: "actions/github-script@v7"
              with:
                  script: |-
                      const { data: labels } = await github.rest.issues.listLabelsForRepo({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                      });

                      if (!labels || labels.length === 0) {
                        core.setFailed('There are no issue labels in this repository.')
                      }

                      const labelNames = labels.map(label => label.name).sort();
                      core.setOutput('available_labels', labelNames.join(','));
                      core.info(`Found ${labelNames.length} labels: ${labelNames.join(', ')}`);
                      return labelNames;

            - name: "Run Gemini Issue Analysis (bulk)"
              id: "gemini_issue_analysis"
              uses: "google-github-actions/run-gemini-cli@v0" # ratchet:exclude
              env:
                  GITHUB_TOKEN: "" # Do not pass any auth token here since this runs on untrusted inputs
                  ISSUES_TO_TRIAGE: "${{ inputs.issues_to_triage }}"
                  REPOSITORY: "${{ github.repository }}"
                  AVAILABLE_LABELS: "${{ steps.get_labels.outputs.available_labels }}"
                  GEMINI_API_KEY: "${{ secrets.GEMINI_API_KEY }}"
                  GOOGLE_API_KEY: "${{ secrets.GOOGLE_API_KEY }}"
              with:
                  gcp_location: "${{ inputs.gcp_location || vars.GOOGLE_CLOUD_LOCATION || '' }}"
                  gcp_project_id: "${{ inputs.gcp_project_id || vars.GOOGLE_CLOUD_PROJECT || '' }}"
                  gcp_service_account: "${{ inputs.gcp_service_account || vars.SERVICE_ACCOUNT_EMAIL || '' }}"
                  gcp_workload_identity_provider: "${{ inputs.gcp_workload_identity_provider || vars.GCP_WIF_PROVIDER || '' }}"
                  gemini_api_key: "${{ secrets.GEMINI_API_KEY }}"
                  gemini_cli_version: "${{ inputs.gemini_cli_version || vars.GEMINI_CLI_VERSION || '' }}"
                  gemini_debug: "${{ fromJSON(inputs.gemini_debug || vars.DEBUG || vars.ACTIONS_STEP_DEBUG || 'false') }}"
                  gemini_model: "${{ inputs.gemini_model || vars.GEMINI_MODEL || '' }}"
                  google_api_key: "${{ secrets.GOOGLE_API_KEY }}"
                  use_gemini_code_assist: "${{ inputs.use_gemini_code_assist || vars.GOOGLE_GENAI_USE_GCA || '' }}"
                  use_vertex_ai: "${{ inputs.use_vertex_ai || vars.GOOGLE_GENAI_USE_VERTEXAI || '' }}"
                  settings: |-
                      {
                        "model": {
                          "maxSessionTurns": 25
                        },
                        "telemetry": {
                          "enabled": ${{ vars.GOOGLE_CLOUD_PROJECT != '' }},
                          "target": "gcp"
                        },
                        "tools": {
                          "core": [
                            "run_shell_command(echo)",
                            "run_shell_command(jq)",
                            "run_shell_command(printenv)"
                          ]
                        },
                        "mcpServers": {
                          "github": {
                            "command": "docker",
                              "args": [
                              "run",
                              "-i",
                              "--rm",
                              "-e",
                              "GITHUB_PERSONAL_ACCESS_TOKEN",
                              "ghcr.io/github/github-mcp-server:v0.18.0"
                            ],
                            "includeTools": [
                              "issue_read",
                              "list_issues",
                              "search_issues"
                            ],
                            "env": {
                              "GITHUB_PERSONAL_ACCESS_TOKEN": "${GITHUB_TOKEN}"
                            }
                          }
                        }
                      }
                  prompt: |-
                      Âá∫Âäõ„ÅØÂøÖ„ÅöÊó•Êú¨Ë™û„ÅßË°å„Å£„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
                      ÂøúÁ≠îË®ÄË™û: ${{ inputs.language }}
                      ## Role
                      You are a highly efficient Issue Triage Engineer. Your function is to analyze GitHub issues and apply the correct labels with precision and consistency. You operate autonomously and produce only the specified JSON output. Your task is to triage and label a list of GitHub issues.

                      ## Primary Directive

                      You will retrieve issue data and available labels from environment variables, analyze the issues, and assign the most relevant labels. You will then generate a single JSON array containing your triage decisions and write it to the file path specified by the `${GITHUB_ENV}` environment variable.

            - name: "Collect outputs"
              id: "collect_outputs"
              uses: "actions/github-script@v7"
              with:
                  script: |-
                      // read TRIAGED_ISSUES from environment and set as step output
                      core.setOutput('triaged_issues', process.env.TRIAGED_ISSUES || '');
