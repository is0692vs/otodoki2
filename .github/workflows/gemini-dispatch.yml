name: "ðŸ”€ Gemini Dispatch"

on:
  pull_request_review_comment:
    types:
      - "created"
  pull_request_review:
    types:
      - "submitted"
  issues:
    types:
      - "opened"
      - "reopened"
  issue_comment:
    types:
      - "created"

defaults:
  run:
    shell: "bash"

jobs:
  debugger:
    if: |-
      ${{ fromJSON(vars.DEBUG || vars.ACTIONS_STEP_DEBUG || false) }}
    runs-on: "ubuntu-latest"
    permissions:
      contents: "read"
    steps:
      - name: "Print context for debugging"
        env:
          DEBUG_event_name: "${{ github.event_name }}"
          DEBUG_event__action: "${{ github.event.action }}"
          DEBUG_event__comment__author_association: "${{ github.event.comment.author_association }}"
          DEBUG_event__issue__author_association: "${{ github.event.issue.author_association }}"
          DEBUG_event__pull_request__author_association: "${{ github.event.pull_request.author_association }}"
          DEBUG_event__review__author_association: "${{ github.event.review.author_association }}"
          DEBUG_event: "${{ toJSON(github.event) }}"
        run: |-
          env | grep '^DEBUG_'

  dispatch:
    # For comments: only if user types @gemini-cli and is OWNER/MEMBER/COLLABORATOR
    # For issues: only on open/reopen
    if: |-
      (
        github.event.sender.type == 'User' &&
        startsWith(github.event.comment.body || github.event.review.body || github.event.issue.body, '@gemini-cli') &&
        contains(fromJSON('["OWNER", "MEMBER", "COLLABORATOR"]'), github.event.comment.author_association || github.event.review.author_association || github.event.issue.author_association)
      ) || (
        github.event_name == 'issues' &&
        contains(fromJSON('["opened", "reopened"]'), github.event.action)
      )
    runs-on: "ubuntu-latest"
    permissions:
      contents: "read"
      issues: "write"
      pull-requests: "write"
    outputs:
      command: "${{ steps.extract_command.outputs.command }}"
      request: "${{ steps.extract_command.outputs.request }}"
      additional_context: "${{ steps.extract_command.outputs.additional_context }}"
      issue_number: "${{ github.event.pull_request.number || github.event.issue.number }}"
    steps:
      - name: "Extract command"
        id: "extract_command"
        uses: "actions/github-script@v7"
        env:
          EVENT_TYPE: "${{ github.event_name }}.${{ github.event.action }}"
          REQUEST: "${{ github.event.comment.body || github.event.review.body || github.event.issue.body }}"
        with:
          script: |
            const request = process.env.REQUEST;
            const eventType = process.env.EVENT_TYPE
            core.setOutput('request', request);

            if (request.startsWith("@gemini-cli /review")) {
              core.setOutput('command', 'review');
              const additionalContext = request.replace(/^@gemini-cli \/review/, '').trim();
              core.setOutput('additional_context', additionalContext);
            } else if (request.startsWith("@gemini-cli /triage")) {
              core.setOutput('command', 'triage');
            } else if (request.startsWith("@gemini-cli")) {
              core.setOutput('command', 'invoke');
              const additionalContext = request.replace(/^@gemini-cli/, '').trim();
              core.setOutput('additional_context', additionalContext);
            } else if (['issues.opened', 'issues.reopened'].includes(eventType)) {
              core.setOutput('command', 'triage');
            } else {
              core.setOutput('command', 'fallthrough');
            }

      - name: "Acknowledge request"
        env:
          GITHUB_TOKEN: "${{ github.token }}"
          ISSUE_NUMBER: "${{ github.event.pull_request.number || github.event.issue.number }}"
          REPOSITORY: "${{ github.repository }}"
        run: |-
          # Add a lightweight emoji reaction instead of posting an acknowledgement comment.
          # Prefer reaction on the triggering comment if present, otherwise react on the issue/PR itself.
          COMMENT_ID=$(jq -r '.comment.id // empty' "$GITHUB_EVENT_PATH")
          if [ -n "${COMMENT_ID}" ]; then
            # Use the PR review comment endpoint for review comments
            if [ "$GITHUB_EVENT_NAME" = "pull_request_review_comment" ]; then
              gh api -H "Accept: application/vnd.github.squirrel-girl-preview+json" --method POST \
                /repos/${REPOSITORY}/pulls/comments/${COMMENT_ID}/reactions -f content="rocket" || true
            else
              gh api -H "Accept: application/vnd.github.squirrel-girl-preview+json" --method POST \
                /repos/${REPOSITORY}/issues/comments/${COMMENT_ID}/reactions -f content="rocket" || true
            fi
          else
            # Fallback: react to the issue or PR itself
            gh api -H "Accept: application/vnd.github.squirrel-girl-preview+json" --method POST \
              /repos/${REPOSITORY}/issues/${ISSUE_NUMBER}/reactions -f content="rocket" || true
          fi

  review:
    needs: "dispatch"
    if: |-
      ${{ needs.dispatch.outputs.command == 'review' }}
    uses: "./.github/workflows/gemini-review.yml"
    permissions:
      contents: "read"
      issues: "write"
      pull-requests: "write"
    with:
      additional_context: "${{ needs.dispatch.outputs.additional_context }}"
      language: "ja"
    secrets: "inherit"

  triage:
    needs: "dispatch"
    if: |-
      ${{ needs.dispatch.outputs.command == 'triage' && github.event.issue }}
    uses: "./.github/workflows/gemini-triage.yml" 
    permissions:
      contents: "read"
      issues: "write"
      pull-requests: "write"
    with:
      additional_context: "${{ needs.dispatch.outputs.additional_context }}"
      language: "ja"
      gemini_model: "gemini-2.5-flash-lite"
    secrets: "inherit"

  invoke:
    needs: "dispatch"
    if: |-
      ${{ false && needs.dispatch.outputs.command == 'invoke' }}
    uses: "./.github/workflows/gemini-invoke.yml"
    permissions:
      contents: "read"
      issues: "write"
      pull-requests: "write"
    with:
      additional_context: "${{ needs.dispatch.outputs.additional_context }}"
      language: "ja"
    secrets: "inherit"

  fallthrough:
    needs:
      - "dispatch"
      - "review"
      - "triage"
      - "invoke"
    if: |-
      ${{ false && always() && !cancelled() && (failure() || needs.dispatch.outputs.command == 'fallthrough') }}
    runs-on: "ubuntu-latest"
    permissions:
      contents: "read"
      issues: "write"
      pull-requests: "write"
    steps:
      - name: "Send failure comment"
        env:
          GITHUB_TOKEN: "${{ github.token }}"
          ISSUE_NUMBER: "${{ github.event.pull_request.number || github.event.issue.number }}"
          REPOSITORY: "${{ github.repository }}"
        run: |-
          # Post a discrete reaction to the triggering comment/issue indicating failure
          COMMENT_ID=$(jq -r '.comment.id // empty' "$GITHUB_EVENT_PATH")
          if [ -n "${COMMENT_ID}" ]; then
            if [ "$GITHUB_EVENT_NAME" = "pull_request_review_comment" ]; then
              gh api -H "Accept: application/vnd.github.squirrel-girl-preview+json" --method POST \
                /repos/${REPOSITORY}/pulls/comments/${COMMENT_ID}/reactions -f content="confused" || true
            else
              gh api -H "Accept: application/vnd.github.squirrel-girl-preview+json" --method POST \
                /repos/${REPOSITORY}/issues/comments/${COMMENT_ID}/reactions -f content="confused" || true
            fi
          else
            gh api -H "Accept: application/vnd.github.squirrel-girl-preview+json" --method POST \
              /repos/${REPOSITORY}/issues/${ISSUE_NUMBER}/reactions -f content="confused" || true
          fi
